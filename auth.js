// main.js
import { auth } from "./firebase-init.js";
import { GoogleAuthProvider, signInWithPopup, signInWithRedirect, getRedirectResult } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-auth.js";

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏
function checkAuthState() {
  return new Promise((resolve) => {
    const unsubscribe = auth.onAuthStateChanged((user) => {
      if (user) {
        updateUIForAuthenticatedUser(user);
      } else {
        updateUIForUnauthenticatedUser();
      }
      unsubscribe();
      resolve(user);
    });
  });
}

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è UI –¥–ª—è –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω–Ω–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
function updateUIForAuthenticatedUser(user) {
  localStorage.setItem("uid", user.uid);
  
  // –û–±–Ω–æ–≤–ª—è–µ–º –∫–Ω–æ–ø–∫—É –ª–æ–≥–∏–Ω–∞
  const loginButton = document.getElementById('loginButton');
  if (loginButton) {
    loginButton.innerHTML = 'üë§ Logout';
  }
  
  // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –∏ –∑–∞–≥—Ä—É–∑–∫–∏ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤
  const saveResultButton = document.getElementById('saveResult');
  const loadResultsButton = document.getElementById('loadResults');
  if (saveResultButton) saveResultButton.style.display = 'inline-block';
  if (loadResultsButton) loadResultsButton.style.display = 'inline-block';
}

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è UI –¥–ª—è –Ω–µ–∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω–Ω–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
function updateUIForUnauthenticatedUser() {
  localStorage.removeItem("uid");
  
  // –û–±–Ω–æ–≤–ª—è–µ–º –∫–Ω–æ–ø–∫—É –ª–æ–≥–∏–Ω–∞
  const loginButton = document.getElementById('loginButton');
  if (loginButton) {
    loginButton.innerHTML = 'üë§ Login';
  }
  
  // –°–∫—Ä—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –∏ –∑–∞–≥—Ä—É–∑–∫–∏ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤
  const saveResultButton = document.getElementById('saveResult');
  const loadResultsButton = document.getElementById('loadResults');
  if (saveResultButton) saveResultButton.style.display = 'none';
  if (loadResultsButton) loadResultsButton.style.display = 'none';
}

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –≤—Ö–æ–¥–∞ —á–µ—Ä–µ–∑ Google
// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è –º–æ–±–∏–ª—å–Ω–æ–≥–æ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞
function isMobileDevice() {
  return /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
}

// –û–±—Ä–∞–±–æ—Ç—á–∏–∫ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞ —Ä–µ–¥–∏—Ä–µ–∫—Ç–∞
async function handleRedirectResult() {
  try {
    const result = await getRedirectResult(auth);
    if (result) {
      const user = result.user;
      console.log("–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤–æ—à—ë–ª –ø–æ—Å–ª–µ —Ä–µ–¥–∏—Ä–µ–∫—Ç–∞:", user);
      
      // –î–æ–±–∞–≤–ª—è–µ–º —Å–ª—É—à–∞—Ç–µ–ª—å –∏–∑–º–µ–Ω–µ–Ω–∏—è —Å–æ—Å—Ç–æ—è–Ω–∏—è –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏
      return new Promise((resolve) => {
        const unsubscribe = auth.onAuthStateChanged((user) => {
          if (user) {
            console.log("–°–æ—Å—Ç–æ—è–Ω–∏–µ –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–æ:", user);
            localStorage.setItem("uid", user.uid);
            
            // –û–±–Ω–æ–≤–ª—è–µ–º UI –¥–ª—è –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω–Ω–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
            updateUIForAuthenticatedUser(user);
            
            // –ó–∞–∫—Ä—ã–≤–∞–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –ø–æ—Å–ª–µ —É—Å–ø–µ—à–Ω–æ–π –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏
            const loginModalEl = document.getElementById("loginModal");
            if (loginModalEl) {
              const loginModal = bootstrap.Modal.getInstance(loginModalEl);
              if (loginModal) {
                loginModal.hide();
                // –£–¥–∞–ª—è–µ–º backdrop –∏ –æ—á–∏—â–∞–µ–º —Å—Ç–∏–ª–∏
                document.body.classList.remove('modal-open');
                const backdrop = document.querySelector('.modal-backdrop');
                if (backdrop) backdrop.remove();
              }
            }
          }
          unsubscribe();
          resolve(user);
        });
      });
    }
  } catch (error) {
    console.error("–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±—Ä–∞–±–æ—Ç–∫–µ —Ä–µ–¥–∏—Ä–µ–∫—Ç–∞:", error);
    if (error.code !== "auth/cancelled-popup-request") {
      alert("–û—à–∏–±–∫–∞ –≤—Ö–æ–¥–∞: " + error.message);
    }
    throw error;
  }
  return null;
}

// –†–µ–∑—É–ª—å—Ç–∞—Ç —Ä–µ–¥–∏—Ä–µ–∫—Ç–∞ –ø—Ä–æ–≤–µ—Ä—è–µ—Ç—Å—è –≤ DOMContentLoaded

// –≠–∫—Å–ø–æ—Ä—Ç–∏—Ä—É–µ–º —Ñ—É–Ω–∫—Ü–∏—é –¥–ª—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –≤ main.js
export async function signInWithGoogle() {
  try {
    const provider = new GoogleAuthProvider();
    
    let user;
    
    if (isMobileDevice()) {
      // –î–ª—è –º–æ–±–∏–ª—å–Ω—ã—Ö —É—Å—Ç—Ä–æ–π—Å—Ç–≤ –∏—Å–ø–æ–ª—å–∑—É–µ–º signInWithRedirect
      console.log("–ò—Å–ø–æ–ª—å–∑—É–µ–º signInWithRedirect –¥–ª—è –º–æ–±–∏–ª—å–Ω–æ–≥–æ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞");
      await signInWithRedirect(auth, provider);
      return null; // –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –±—É–¥–µ—Ç –¥–æ—Å—Ç—É–ø–µ–Ω —Ç–æ–ª—å–∫–æ –ø–æ—Å–ª–µ —Ä–µ–¥–∏—Ä–µ–∫—Ç–∞
    } else {
      // –î–ª—è –¥–µ—Å–∫—Ç–æ–ø–æ–≤ –∏—Å–ø–æ–ª—å–∑—É–µ–º signInWithPopup
      const result = await signInWithPopup(auth, provider);
      user = result.user;
      console.log("–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤–æ—à—ë–ª:", user);
      
      localStorage.setItem("uid", user.uid);
      
      // –ó–∞–∫—Ä—ã–≤–∞–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –ø–æ—Å–ª–µ —É—Å–ø–µ—à–Ω–æ–π –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏
      const loginModalEl = document.getElementById("loginModal");
      if (loginModalEl) {
        const loginModal = bootstrap.Modal.getInstance(loginModalEl);
        if (loginModal) {
          loginModal.hide();
          // –£–¥–∞–ª—è–µ–º backdrop –∏ –æ—á–∏—â–∞–µ–º —Å—Ç–∏–ª–∏
          document.body.classList.remove('modal-open');
          const backdrop = document.querySelector('.modal-backdrop');
          if (backdrop) backdrop.remove();
        }
      }
      
      return user;
    }
  } catch (error) {
    console.error("–û—à–∏–±–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏:", error);
    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –æ—à–∏–±–∫—É —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –æ–Ω–∞ –Ω–µ —Å–≤—è–∑–∞–Ω–∞ —Å –æ—Ç–º–µ–Ω–æ–π –∑–∞–ø—Ä–æ—Å–∞
    if (error.code !== "auth/cancelled-popup-request") {
      alert("–û—à–∏–±–∫–∞ –≤—Ö–æ–¥–∞: " + error.message);
    }
    throw error;
  }
}

// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
document.addEventListener("DOMContentLoaded", async () => {
  try {
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç —Ä–µ–¥–∏—Ä–µ–∫—Ç–∞
    const result = await getRedirectResult(auth);
    if (result) {
      const user = result.user;
      console.log("–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤–æ—à—ë–ª –ø–æ—Å–ª–µ —Ä–µ–¥–∏—Ä–µ–∫—Ç–∞:", user);
      localStorage.setItem("uid", user.uid);
      updateUIForAuthenticatedUser(user);
    }

    // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ç–µ–∫—É—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏
    const currentUser = auth.currentUser;
    if (currentUser) {
      console.log("–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —É–∂–µ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω:", currentUser);
      localStorage.setItem("uid", currentUser.uid);
      updateUIForAuthenticatedUser(currentUser);
    } else {
      console.log("–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω");
      updateUIForUnauthenticatedUser();
    }
  } catch (error) {
    console.error("–û—à–∏–±–∫–∞ –ø—Ä–∏ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏:", error);
  }
});
