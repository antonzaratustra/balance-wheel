// –ì–ª–æ–±–∞–ª—å–Ω—ã–π –æ–±—ä–µ–∫—Ç —Å –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—è–º–∏ FAQ
const faqInstructions = {
  ru: `<strong>–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –≤ Mentorist Life Balance Wheel!</strong><br><br>
  –≠—Ç–æ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç –¥–ª—è –æ—Ü–µ–Ω–∫–∏ –±–∞–ª–∞–Ω—Å–∞ –∂–∏–∑–Ω–∏ –ø–æ 8 –∫–ª—é—á–µ–≤—ã–º —Å—Ñ–µ—Ä–∞–º: –ó–¥–æ—Ä–æ–≤—å–µ, –û—Ç–Ω–æ—à–µ–Ω–∏—è, –û–∫—Ä—É–∂–µ–Ω–∏–µ, –ü—Ä–∏–∑–≤–∞–Ω–∏–µ, –§–∏–Ω–∞–Ω—Å—ã, –°–∞–º–æ—Ä–∞–∑–≤–∏—Ç–∏–µ, –Ø—Ä–∫–æ—Å—Ç—å –∂–∏–∑–Ω–∏ –∏ –î—É—Ö–æ–≤–Ω–æ—Å—Ç—å.<br><br>
  <strong>1. –¢–µ–º–∞ –∏ —è–∑—ã–∫:</strong> –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –∫–Ω–æ–ø–∫–∏ –¥–ª—è —Å–º–µ–Ω—ã —Ç–µ–º—ã –∏ —è–∑—ã–∫–∞ <span class="btn-like">üåê RU</span> –∏ <span class="btn-like">üåô –¢—ë–º–Ω–∞—è</span> / <span class="btn-like">üåû –°–≤–µ—Ç–ª–∞—è</span>.<br><br>
  <strong>2. FAQ:</strong> –ù–∞–∂–º–∏—Ç–µ <span class="btn-like">üí° FAQ</span> –¥–ª—è —ç—Ç–æ–π –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏; –¥–ª—è –≤–æ–∑–≤—Ä–∞—Ç–∞ –∫ —Å—Ñ–µ—Ä–∞–º ‚Äì –Ω–∞–∂–º–∏—Ç–µ –≤–∫–ª–∞–¥–∫—É —Å—Ñ–µ—Ä—ã, –Ω–∞–ø—Ä–∏–º–µ—Ä <span class="btn-like">‚ù§Ô∏è –ó–¥–æ—Ä–æ–≤—å–µ (5.0)</span>.<br><br>
  <strong>3. –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ:</strong> –í–∫–ª–∞–¥–∫–∏ –≤–≤–µ—Ä—Ö—É –ø–æ–∑–≤–æ–ª—è—é—Ç –ø–µ—Ä–µ–∫–ª—é—á–∞—Ç—å—Å—è –º–µ–∂–¥—É —Å—Ñ–µ—Ä–∞–º–∏ –∂–∏–∑–Ω–∏.<br><br>
  <strong>4. –û—Ü–µ–Ω–∫–∞:</strong> –í –∫–∞–∂–¥–æ–π —Å—Ñ–µ—Ä–µ –µ—Å—Ç—å 5 –≤–æ–ø—Ä–æ—Å–æ–≤. –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ —Å–ª–∞–π–¥–µ—Ä—ã –¥–ª—è –æ—Ü–µ–Ω–∫–∏ –æ—Ç 0 –¥–æ 10.<br><br>
  <strong>5. –í–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏—è:</strong> –ö–æ–ª–µ—Å–æ –±–∞–ª–∞–Ω—Å–∞ –Ω–∞–≥–ª—è–¥–Ω–æ –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç –≤–∞—à–∏ –æ—Ü–µ–Ω–∫–∏.<br><br>
  <strong>6. –°—Ä–µ–¥–Ω–µ–µ:</strong> –î–ª—è –∫–∞–∂–¥–æ–π —Å—Ñ–µ—Ä—ã –∏ –æ–±—â–µ–µ —Å—Ä–µ–¥–Ω–µ–µ –∑–Ω–∞—á–µ–Ω–∏–µ —Ä–∞—Å—Å—á–∏—Ç—ã–≤–∞—é—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏.<br><br>
  <strong>7. –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ:</strong> –î–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ –Ω–∞–∂–º–∏—Ç–µ <span class="btn-like">üë§ Login</span>, —á—Ç–æ–±—ã –≤–æ–π—Ç–∏. –ü–æ—Å–ª–µ —ç—Ç–æ–≥–æ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ –∫–Ω–æ–ø–∫—É <span class="btn-like">üíæ</span> –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –≤ –æ–±–ª–∞–∫–æ –∏–ª–∏ <span class="btn-like">‚òÅÔ∏è</span> –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ —Å–æ—Ö—Ä–∞–Ω—ë–Ω–Ω—ã—Ö —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤. –ö–Ω–æ–ø–∫–∞ <span class="btn-like">üîΩ PDF</span> –ø–æ–∑–≤–æ–ª—è–µ—Ç —Å–∫–∞—á–∞—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –≤ —Ñ–æ—Ä–º–∞—Ç–µ PDF.<br><br>
  <strong>8. –ò—Å—Ç–æ—Ä–∏—è:</strong> –ü–æ—Å–ª–µ –≤—Ö–æ–¥–∞ –≤ —Å–∏—Å—Ç–µ–º—É –≤—ã –º–æ–∂–µ—Ç–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —Å–ª–∞–π–¥–µ—Ä –∏—Å—Ç–æ—Ä–∏–∏ –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –ø—Ä–µ–¥—ã–¥—É—â–∏—Ö —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤. –°–ª–∞–π–¥–µ—Ä –Ω–∞—Ö–æ–¥–∏—Ç—Å—è –ø–æ–¥ –∫–æ–ª–µ—Å–æ–º –±–∞–ª–∞–Ω—Å–∞ –∏ –ø–æ–∑–≤–æ–ª—è–µ—Ç –ø–µ—Ä–µ–º–µ—â–∞—Ç—å—Å—è –º–µ–∂–¥—É —Å–æ—Ö—Ä–∞–Ω—ë–Ω–Ω—ã–º–∏ –¥–∞—Ç–∞–º–∏. –ü—Ä–∏ –≤—ã–±–æ—Ä–µ –¥–∞—Ç—ã –∫–æ–ª–µ—Å–æ –æ–±–Ω–æ–≤–ª—è–µ—Ç—Å—è —Å –æ—Ü–µ–Ω–∫–∞–º–∏ –Ω–∞ —ç—Ç—É –¥–∞—Ç—É.`,
    
  en: `<strong>Welcome to Mentorist Life Balance Wheel!</strong><br><br>
  This is a tool for assessing life balance across 8 key areas: Health, Relationships, Environment, Calling, Finance, Self-Improvement, Life Brightness, and Spirituality.<br><br>
  <strong>1. Theme and Language:</strong> Use the buttons to switch theme and language <span class="btn-like">üåê EN</span> and <span class="btn-like">üåô Dark</span> / <span class="btn-like">üåû Light</span>.<br><br>
  <strong>2. FAQ:</strong> Click <span class="btn-like">üí° FAQ</span> for this instruction; to return to spheres - click the sphere tab, e.g., <span class="btn-like">‚ù§Ô∏è Health (5.0)</span>.<br><br>
  <strong>3. Switching:</strong> Tabs at the top allow you to switch between life areas.<br><br>
  <strong>4. Assessment:</strong> Each area has 5 questions. Use sliders to rate from 0 to 10.<br><br>
  <strong>5. Visualization:</strong> The balance wheel visually displays your ratings.<br><br>
  <strong>6. Average:</strong> Average values for each area and overall are calculated automatically.<br><br>
  <strong>7. Saving:</strong> To save results, click <span class="btn-like">üë§ Login</span> to log in. Then use the <span class="btn-like">üíæ</span> button to save to the cloud or <span class="btn-like">‚òÅÔ∏è</span> to view saved results. The <span class="btn-like">üîΩ PDF</span> button allows you to download results as PDF.<br><br>
  <strong>8. History:</strong> After logging in, you can use the history slider to view previous results. The slider is located below the balance wheel and allows you to navigate between saved dates. When you select a date, the wheel updates with ratings from that date.`
};

// –ò–º–ø–æ—Ä—Ç auth –∏–∑ firebase-init.js
import { auth } from "./firebase-init.js";
import { DejaVuSansTTF } from './fonts.js';
import { spheres } from './js/spheres.js';

// –ò–º–ø–æ—Ä—Ç –Ω—É–∂–Ω—ã—Ö –º–µ—Ç–æ–¥–æ–≤ –∏–∑ firebase/auth
import {
  GoogleAuthProvider,
  signInWithPopup,
  signOut,
  onAuthStateChanged
} from "https://www.gstatic.com/firebasejs/9.22.2/firebase-auth.js";

import {
  saveResultToFirestore,
  loadResultsList,
  loadSavedResult,
  deleteSavedResult
} from "./firestore-utils.js";

document.addEventListener("DOMContentLoaded", () => {
  // –£–¥–∞–ª—è–µ–º –∑–∞–≥—Ä—É–∑—á–∏–∫
  const loader = document.getElementById("loader");
  if (loader) {
    loader.remove();
  }

  function initLoadingAnimation() {
    const colMd7 = document.querySelector('.col-md-7');
    const canvasWrapper = document.getElementById('canvas-wrapper');
    const faqContent = document.getElementById('faqContent');
    
    colMd7.classList.add('loading');
    canvasWrapper.classList.add('loading');
    faqContent.classList.add('loading');
    
    setTimeout(() => {
      colMd7.classList.remove('loading');
      canvasWrapper.classList.remove('loading');
      faqContent.classList.remove('loading');
    }, 50);
  }
  initLoadingAnimation();

  // –ì–ª–æ–±–∞–ª—å–Ω–∞—è –ø–µ—Ä–µ–º–µ–Ω–Ω–∞—è –¥–ª—è –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è –º–æ–±–∏–ª—å–Ω–æ–≥–æ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞
  let isMobile = window.innerWidth < 576;
  window.addEventListener("resize", () => {
    isMobile = window.innerWidth < 576;
  });

  function fillCanvasBackground(canvas, color) {
    const ctx = canvas.getContext("2d");
    ctx.save();
    ctx.globalCompositeOperation = "destination-over";
    ctx.fillStyle = color;
    ctx.fillRect(0, 0, canvas.width, canvas.height);
    ctx.restore();
  }

  /***************************************************
   * 1. –ü–ê–†–ê–ú–ï–¢–†–´ –ü–û –£–ú–û–õ–ß–ê–ù–ò–Æ: –¢–Å–ú–ù–ê–Ø –¢–ï–ú–ê + –ê–ù–ì–õ–ò–ô–°–ö–ò–ô
   ***************************************************/
  let currentLanguage = "en"; // –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é –∞–Ω–≥–ª–∏–π—Å–∫–∏–π
  let darkMode = true;        // –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é —Ç—ë–º–Ω–∞—è —Ç–µ–º–∞

  // –ì–ª–æ–±–∞–ª—å–Ω—ã–π –º–∞—Å—Å–∏–≤ –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è –≥–µ–æ–º–µ—Ç—Ä–∏–∏ —Å–µ–∫—Ç–æ—Ä–æ–≤
  let wheelSectors = [];

  // –û–±—ä–µ–∫—Ç –¥–ª—è —Ç–µ–∫—Å—Ç–æ–≤ –∫–Ω–æ–ø–æ–∫ (–∏—Å–ø–æ–ª—å–∑—É–µ–º –∏ –¥–ª—è –¥–µ—Å–∫—Ç–æ–ø–∞, –∏ –¥–ª—è –º–æ–±–∏–ª—å–Ω–æ–π –≤–µ—Ä—Å–∏–∏)
  const buttonTexts = {
    ru: {
      save: 'üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å',
      login: 'üë§ –í–æ–π—Ç–∏',
      logout: 'üë§ –í—ã–π—Ç–∏',
      view: '‚òÅÔ∏è –ü—Ä–æ—Å–º–æ—Ç—Ä–µ—Ç—å'
    },
    en: {
      save: 'üíæ Save',
      login: 'üë§ Login',
      logout: 'üë§ Logout',
      view: '‚òÅÔ∏è Results'
    }
  };

  // ================== –ë–õ–û–ö –° –ú–û–î–ê–õ–¨–ù–´–ú–ò –û–ö–ù–ê–ú–ò ==================
  const modalTranslations = {
    ru: {
      savedToCloud: "–£—Å–ø–µ—Ö",
      savedToCloudContent: "–†–µ–∑—É–ª—å—Ç–∞—Ç —Å–æ—Ö—Ä–∞–Ω—ë–Ω",
      loaded: "–£—Å–ø–µ—Ö",
      loadedContent: "–†–µ–∑—É–ª—å—Ç–∞—Ç –∑–∞–≥—Ä—É–∂–µ–Ω",
      deleteConfirm: "–í–Ω–∏–º–∞–Ω–∏–µ",
      deleteConfirmContent: "–£–¥–∞–ª–∏—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç?",
      deleted: "–£—Å–ø–µ—Ö",
      deletedContent: "–†–µ–∑—É–ª—å—Ç–∞—Ç —É–¥–∞–ª–µ–Ω",
      loginRequired: "–í—Ö–æ–¥",
      loginRequiredContent: "–°–Ω–∞—á–∞–ª–∞ –≤–æ–π–¥–∏—Ç–µ –≤ —Å–∏—Å—Ç–µ–º—É!",
      myResults: "–†–µ–∑—É–ª—å—Ç–∞—Ç—ã",
      success: "–£—Å–ø–µ—Ö",
      delete: "–£–¥–∞–ª–∏—Ç—å",
      noResults: "–ù–µ—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤",
      load: "–ó–∞–≥—Ä—É–∑–∏—Ç—å",
      cancel: "–û—Ç–º–µ–Ω–∞"
    },
    en: {
      savedToCloud: "Success",
      savedToCloudContent: "Result saved",
      loaded: "Success",
      loadedContent: "Result loaded",
      deleteConfirm: "Warning",
      deleteConfirmContent: "Delete result?",
      deleted: "Success",
      deletedContent: "Result deleted",
      loginRequired: "Login",
      loginRequiredContent: "Please log in first!",
      myResults: "Results",
      success: "Success",
      delete: "Delete",
      noResults: "No results",
      load: "Load",
      cancel: "Cancel"
    }
  };

  function showModal(modalId, messageKey = null) {
    const modal = document.getElementById(modalId);
    if (modal && messageKey) {
      const modalTitle = modal.querySelector('.modal-title');
      const modalBody = modal.querySelector('.modal-body');
      const translations = modalTranslations[currentLanguage];
      if (modalTitle) {
        modalTitle.textContent = translations[messageKey] || translations.success;
      }
      if (modalBody) {
        modalBody.textContent = translations[`${messageKey}Content`] || translations.success;
      }
    }
    if (modal) {
      new bootstrap.Modal(modal).show();
    }
  }

  function showConfirmDeleteModal(onConfirm) {
    const modal = document.getElementById('confirmDeleteModal');
    if (modal) {
      const translations = modalTranslations[currentLanguage];
      const modalTitle = modal.querySelector('.modal-title');
      const modalBody = modal.querySelector('.modal-body');
      const confirmBtn = modal.querySelector('.btn-danger');
      const cancelBtn = modal.querySelector('.btn-secondary');
      
      if (modalTitle) {
        modalTitle.textContent = translations.deleteConfirm;
      }
      if (modalBody) {
        modalBody.textContent = translations.deleteConfirmContent;
      }
      if (confirmBtn) {
        confirmBtn.textContent = translations.delete;
        confirmBtn.onclick = () => {
          const modalInstance = bootstrap.Modal.getInstance(modal);
          if (modalInstance) {
            modalInstance.hide();
          }
          onConfirm();
        };
      }
      if (cancelBtn) {
        cancelBtn.textContent = translations.cancel || 'Cancel';
      }
      new bootstrap.Modal(modal).show();
    }
  }
  // ==============================================================

  // ===================== –ë–õ–û–ö –° –ê–í–¢–û–†–ò–ó–ê–¶–ò–ï–ô =====================
  // –ö–Ω–æ–ø–∫–∏ –≤—Ö–æ–¥–∞/–≤—ã—Ö–æ–¥–∞ (–¥–µ—Å–∫—Ç–æ–ø + –º–æ–±–∏–ª—å–Ω—ã–π)
  const loginBtn = document.getElementById("loginBtn");
  const mobileLoginBtn = document.getElementById('mobile-login-btn');

  // –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –ª–æ–≥–∏–Ω–∞
  const loginModalEl = document.getElementById("loginModal");

  // –ö–Ω–æ–ø–∫–∞ Google –≤–Ω—É—Ç—Ä–∏ –º–æ–¥–∞–ª–∫–∏
  const googleSignInBtn = document.getElementById("googleSignInBtn");

  // –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –∏–º–µ–Ω–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
  const userInfo = document.getElementById("userInfo"); 
  const userInfoMobile = document.getElementById("userInfo-mobile"); 

  // –£–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –≤—Ö–æ–¥–∞ —á–µ—Ä–µ–∑ Google (—á—Ç–æ–±—ã –º–æ–∂–Ω–æ –±—ã–ª–æ –≤—ã–∑–≤–∞—Ç—å –∏–∑ —Ä–∞–∑–Ω—ã—Ö –º–µ—Å—Ç)
  async function signInWithGoogle() {
    const provider = new GoogleAuthProvider();
    const result = await signInWithPopup(auth, provider);
    return result.user;
  }

  // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –Ω–∞–∂–∞—Ç–∏—è ¬´–í–æ–π—Ç–∏ —á–µ—Ä–µ–∑ Google¬ª (–∫–Ω–æ–ø–∫–∞ –≤ –º–æ–¥–∞–ª–∫–µ)
  if (googleSignInBtn) {
    googleSignInBtn.addEventListener("click", async () => {
      try {
        const user = await signInWithGoogle();
        if (user) {
          // –ó–∞–∫—Ä—ã–≤–∞–µ–º –º–æ–¥–∞–ª–∫—É –ø–æ—Å–ª–µ —É—Å–ø–µ—à–Ω–æ–≥–æ –≤—Ö–æ–¥–∞
          const loginModal = bootstrap.Modal.getInstance(document.getElementById("loginModal"));
          if (loginModal) {
            loginModal.hide();
          }
          // –û–±–Ω–æ–≤–ª—è–µ–º UI-–∫–Ω–æ–ø–∫–∏ (–ª–æ–≥–∏–Ω/–ª–æ–≥–∞—É—Ç)
          updateLoginButtons();
        }
      } catch (error) {
        console.error("–û—à–∏–±–∫–∞ –ø—Ä–∏ –≤—Ö–æ–¥–µ:", error);
      }
    });
  }

  // –§—É–Ω–∫—Ü–∏—è –≤—ã—Ö–æ–¥–∞
  function handleSignOut() {
    signOut(auth)
      .then(() => {
        console.log("–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤—ã—à–µ–ª");
      })
      .catch((err) => {
        console.error("–û—à–∏–±–∫–∞ –ø—Ä–∏ –≤—ã—Ö–æ–¥–µ:", err);
        showModal("logoutErrorModal", 'loginRequired');
      });
  }

  // –ï–¥–∏–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è-–æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–ª–∏–∫–∞ –ø–æ –∫–Ω–æ–ø–∫–µ Login/Logout (–¥–µ—Å–∫—Ç–æ–ø –∏ –º–æ–±–∏–ª—å–Ω–∞—è)
  function handleLoginClick() {
    if (auth.currentUser) {
      // –£–∂–µ –∑–∞–ª–æ–≥–∏–Ω–µ–Ω ‚Äì –≤—ã—Ö–æ–¥–∏–º
      handleSignOut();
    } else {
      // –ù–µ –∑–∞–ª–æ–≥–∏–Ω–µ–Ω ‚Äì –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –º–æ–¥–∞–ª–∫—É
      const loginModal = new bootstrap.Modal(loginModalEl, {
        backdrop: true,
        keyboard: true
      });
      loginModal.show();
    }
  }

  // –ù–∞–≤–µ—à–∏–≤–∞–µ–º –Ω–∞ –æ–±–µ –∫–Ω–æ–ø–∫–∏
  loginBtn.addEventListener("click", handleLoginClick);
  mobileLoginBtn.addEventListener("click", handleLoginClick);

  // ===================== –ö–û–ù–ï–¶ –ë–õ–û–ö–ê –ê–í–¢–û–†–ò–ó–ê–¶–ò–ò =====================

  // ===================== –ë–õ–û–ö –° –°–û–•–†–ê–ù–ï–ù–ò–ï–ú/–ü–†–û–°–ú–û–¢–†–û–ú =====================
  // –î–µ—Å–∫—Ç–æ–ø–Ω—ã–µ –∫–Ω–æ–ø–∫–∏
  const saveToCloudBtn = document.getElementById("saveToCloudBtn");
  const showResultsBtn = document.getElementById("showResultsBtn");

  // –ú–æ–±–∏–ª—å–Ω—ã–µ –∫–Ω–æ–ø–∫–∏
  const mobileSaveBtn = document.getElementById('mobile-save-btn');
  const mobileViewBtn = document.getElementById('mobile-view-btn');

  // –§—É–Ω–∫—Ü–∏—è –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞
  async function saveResult() {
    try {
      await saveResultToFirestore(new Date().toLocaleString(), spheres);
      showModal('saveSuccessModal', 'savedToCloud');
      // –û–±–Ω–æ–≤–ª—è–µ–º —Å–ª–∞–π–¥–µ—Ä –∏—Å—Ç–æ—Ä–∏–∏ –ø–æ—Å–ª–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è
      initializeHistorySlider();
    } catch (error) {
      console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏:', error);
    }
  }

  // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–µ—Å–∫—Ç–æ–ø–Ω–æ–π –∫–Ω–æ–ø–∫–∏ ¬´—Å–æ—Ö—Ä–∞–Ω–∏—Ç—å¬ª
  if (saveToCloudBtn) {
    saveToCloudBtn.addEventListener('click', () => {
      if (!auth.currentUser) {
        showModal("authModal", 'loginRequired');
        return;
      }
      saveResult();
    });
  }

  // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –º–æ–±–∏–ª—å–Ω—ã—Ö –∫–Ω–æ–ø–æ–∫ (save/view)
  mobileSaveBtn.addEventListener('click', () => {
    if (!auth.currentUser) {
      showModal("authModal", 'loginRequired');
      return;
    }
    saveResult();
  });

  mobileViewBtn.addEventListener('click', async () => {
    if (!auth.currentUser) {
      showModal("authModal", 'loginRequired');
      return;
    }
    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –º–æ–¥–∞–ª–∫—É —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤
    showResultsModal();
  });

  // –î–µ—Å–∫—Ç–æ–ø–Ω–∞—è –∫–Ω–æ–ø–∫–∞ ¬´–ø–æ–∫–∞–∑–∞—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã¬ª
  showResultsBtn.addEventListener("click", async () => {
    if (!auth.currentUser) {
      showModal("authModal", 'loginRequired');
      return;
    }
    showResultsModal();
  });

  // –§—É–Ω–∫—Ü–∏—è –ø–æ–∫–∞–∑–∞ –º–æ–¥–∞–ª–∫–∏ ¬´–ú–æ–∏ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã¬ª
  async function showResultsModal() {
    const resultsModalEl = document.getElementById("resultsModal");
    const resultsModal = new bootstrap.Modal(resultsModalEl, {
      backdrop: "static",
      keyboard: true
    });
    try {
      const entries = await loadResultsList();
      const resultsListEl = document.getElementById("resultsList");

      resultsListEl.innerHTML = "";

      if (entries.length === 0) {
        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º "–Ω–µ—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤"
        const noResultsDiv = document.createElement("div");
        noResultsDiv.classList.add("text-center", "py-4");

        const travoltaImg = document.createElement("img");
        travoltaImg.src = "img/travolta.gif";
        travoltaImg.alt = "–ù–µ—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤";
        travoltaImg.style.maxWidth = "200px";

        const noResultsText = document.createElement("p");
        noResultsText.classList.add("mt-3", "text-muted");
        noResultsText.textContent = currentLanguage === "ru" 
          ? "–ü–æ–∫–∞ –Ω–µ—Ç —Å–æ—Ö—Ä–∞–Ω—ë–Ω–Ω—ã—Ö —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤" 
          : "No saved results yet";

        noResultsDiv.appendChild(travoltaImg);
        noResultsDiv.appendChild(noResultsText);
        resultsListEl.appendChild(noResultsDiv);
      } else {
        entries.forEach((entry) => {
          const row = document.createElement("div");
          row.classList.add("d-flex", "justify-content-between", "align-items-center", "mb-2");

          const titleSpan = document.createElement("span");
          titleSpan.style.flexGrow = "1";
          titleSpan.style.marginRight = "1rem";
          const dateStr = entry.createdAt?.seconds
            ? new Date(entry.createdAt.seconds * 1000).toLocaleString()
            : new Date().toLocaleString();
          titleSpan.textContent = dateStr;

          const buttonsContainer = document.createElement("div");
          buttonsContainer.classList.add("d-flex", "align-items-center");
          buttonsContainer.style.flexShrink = "0";

          const loadBtn = document.createElement("button");
          loadBtn.className = "btn btn-sm btn-primary me-2";
          loadBtn.textContent = "‚ñ∂Ô∏è";
          loadBtn.style.width = "40px";

          const delBtn = document.createElement("button");
          delBtn.className = "btn btn-sm btn-danger";
          delBtn.textContent = "‚ùå";
          delBtn.style.width = "40px";

          loadBtn.addEventListener("click", async () => {
            const data = await loadSavedResult(entry.id);
            if (!data) {
              showModal("loadErrorModal", 'loaded');
              return;
            }
            // –ü—Ä–∏–º–µ–Ω—è–µ–º –¥–∞–Ω–Ω—ã–µ –∫ —Å–ª–∞–π–¥–µ—Ä–∞–º
            Object.keys(data).forEach(sphereId => {
              const sphereData = data[sphereId];
              Object.keys(sphereData).forEach(questionId => {
                const slider = document.getElementById(`slider_${sphereId}_${questionId}`);
                if (slider) {
                  slider.value = sphereData[questionId];
                  updateSliderDisplay(sphereId, questionId, sphereData[questionId]);
                }
              });
              updateSphereAverage(sphereId);
            });
            updateOverallAverage();
            drawWheel();
            const modal = bootstrap.Modal.getInstance(resultsModalEl);
            if (modal) {
              modal.hide();
            }
            showModal("loadSuccessModal", 'loaded');
          });

          delBtn.addEventListener("click", async () => {
            showConfirmDeleteModal(async () => {
              try {
                await deleteSavedResult(entry.id);
                const modal = bootstrap.Modal.getInstance(resultsModalEl);
                if (modal) {
                  modal.hide();
                }
                showResultsModal(); // –ø–µ—Ä–µ–≥—Ä—É–∂–∞–µ–º —Å–ø–∏—Å–æ–∫
                initializeHistorySlider();
                showModal("deleteSuccessModal", 'deleted');
              } catch (error) {
                console.error("–û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏:", error);
                showModal("deleteErrorModal", 'deleteConfirm');
              }
            });
          });

          buttonsContainer.appendChild(loadBtn);
          buttonsContainer.appendChild(delBtn);
          row.appendChild(titleSpan);
          row.appendChild(buttonsContainer);
          resultsListEl.appendChild(row);
        });
      }

      // –û–±–Ω–æ–≤–ª—è–µ–º –∑–∞–≥–æ–ª–æ–≤–æ–∫ –º–æ–¥–∞–ª–∫–∏ ¬´–ú–æ–∏ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã¬ª
      const resultsModalTitle = document.querySelector('#resultsModal .modal-title');
      if (resultsModalTitle) {
        resultsModalTitle.textContent = modalTranslations[currentLanguage].myResults;
      }

      resultsModal.show();
    } catch (error) {
      console.error("–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤:", error);
      showModal("loadErrorModal", 'loaded');
    }
  }

  // ==================== –ö–û–ù–ï–¶ –ë–õ–û–ö–ê –°–û–•–†–ê–ù–ï–ù–ò–Ø/–ü–†–û–°–ú–û–¢–†–ê ====================


  // ==================  –§–£–ù–ö–¶–ò–ò –û–ë–ù–û–í–õ–ï–ù–ò–Ø –¢–ï–ö–°–¢–ê –ö–ù–û–ü–û–ö  ====================
  /**
   * –ú–µ–Ω—è–µ—Ç —Ç–µ–∫—Å—Ç –∫–Ω–æ–ø–æ–∫ Login/Logout (–¥–µ—Å–∫—Ç–æ–ø+–º–æ–±.) –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç:
   *   - —Ç–µ–∫—É—â–µ–≥–æ —è–∑—ã–∫–∞ (currentLanguage)
   *   - auth.currentUser (–∑–∞–ª–æ–≥–∏–Ω–µ–Ω –∏–ª–∏ –Ω–µ—Ç)
   */
  function updateLoginButtons() {
    if (auth.currentUser) {
      // –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∑–∞–ª–æ–≥–∏–Ω–µ–Ω
      loginBtn.innerText = (currentLanguage === 'ru') ? 'üë§ –í—ã–π—Ç–∏' : 'üë§ Logout';
      mobileLoginBtn.textContent = (currentLanguage === 'ru') ? 'üë§ –í—ã–π—Ç–∏' : 'üë§ Logout';
    } else {
      // –ù–µ –∑–∞–ª–æ–≥–∏–Ω–µ–Ω
      loginBtn.innerText = (currentLanguage === 'ru') ? 'üë§ –í–æ–π—Ç–∏' : 'üë§ Login';
      mobileLoginBtn.textContent = (currentLanguage === 'ru') ? 'üë§ –í–æ–π—Ç–∏' : 'üë§ Login';
    }
  }

  /**
   * –ú–µ–Ω—è–µ—Ç —Ç–µ–∫—Å—Ç –∫–Ω–æ–ø–æ–∫ ¬´–°–æ—Ö—Ä–∞–Ω–∏—Ç—å¬ª –∏ ¬´–ü—Ä–æ—Å–º–æ—Ç—Ä–µ—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã¬ª (–¥–µ—Å–∫—Ç–æ–ø+–º–æ–±.)
   * –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç currentLanguage.
   */
  function updateSaveButtons() {
    // –î–µ—Å–∫—Ç–æ–ø
    if (saveToCloudBtn) {
      saveToCloudBtn.innerText = buttonTexts[currentLanguage].save;
    }
    if (showResultsBtn) {
      showResultsBtn.innerText = buttonTexts[currentLanguage].view;
    }
    // –ú–æ–±–∏–ª—å–Ω—ã–µ
    if (mobileSaveBtn) {
      mobileSaveBtn.innerText = buttonTexts[currentLanguage].save;
    }
    if (mobileViewBtn) {
      mobileViewBtn.innerText = buttonTexts[currentLanguage].view;
    }
  }

  // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –∏–º–µ–Ω–∏/–µ–º–µ–π–ª–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ —à–∞–ø–∫–µ
  function updateUserInfo() {
    const user = auth.currentUser;
    if (user) {
      const displayName = user.displayName || user.email || "";
      userInfo.textContent = displayName;
      userInfoMobile.textContent = displayName;
    } else {
      userInfo.textContent = "";
      userInfoMobile.textContent = "";
    }
  }

  /**
   * updateUILanguage() ‚Äî –æ–±–Ω–æ–≤–ª—è–µ—Ç –≤–µ—Å—å UI –ø–æ–¥ –≤—ã–±—Ä–∞–Ω–Ω—ã–π —è–∑—ã–∫:
   *   - –∫–Ω–æ–ø–∫–∏ –ª–æ–≥–∏–Ω–∞/–ª–æ–≥–∞—É—Ç–∞
   *   - –∫–Ω–æ–ø–∫–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è/–ø—Ä–æ—Å–º–æ—Ç—Ä–∞
   *   - –º–æ–¥–∞–ª–∫–∏, –∑–∞–≥–æ–ª–æ–≤–∫–∏, –ø—Ä–æ—á–µ–µ
   */
  function updateUILanguage() {
    // 1. –û–±–Ω–æ–≤–ª—è–µ–º —Ç–µ–∫—Å—Ç –∫–Ω–æ–ø–æ–∫ (Login/Logout + Save/View)
    updateLoginButtons();
    updateSaveButtons();

    // 2. –û–±–Ω–æ–≤–ª—è–µ–º userInfo
    updateUserInfo();

    // 3. –û–±–Ω–æ–≤–ª—è–µ–º —Ç–µ–∫—Å—Ç –º–æ–¥–∞–ª–∫–∏ –ª–æ–≥–∏–Ω–∞
    const loginModalLabel = document.getElementById("loginModalLabel");
    const modalBodyText = document.querySelector("#loginModal .modal-body p");
    if (currentLanguage === "ru") {
      if (loginModalLabel) loginModalLabel.innerText = "–í—Ö–æ–¥";
      if (modalBodyText) modalBodyText.innerText = "–í–æ–π–¥–∏—Ç–µ —Å –ø–æ–º–æ—â—å—é:";
    } else {
      if (loginModalLabel) loginModalLabel.innerText = "Login";
      if (modalBodyText) modalBodyText.innerText = "Sign in with:";
    }
    // 4. –ò —Ç.–¥. ‚Äî –ø—Ä–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏
  }
  // ===========================================================================


  // ======================== onAuthStateChanged ================================
  onAuthStateChanged(auth, (user) => {
    if (user) {
      console.log("–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω:", user.uid);
      // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º —Å–ª–∞–π–¥–µ—Ä –∏—Å—Ç–æ—Ä–∏–∏ –ø–æ—Å–ª–µ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏
      initializeHistorySlider();
    } else {
      console.log("–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω");
      // –ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤—ã—à–µ–ª ‚Äî —Å–∫—Ä—ã—Ç—å —Å–ª–∞–π–¥–µ—Ä
      const historySliderContainer = document.getElementById("historySliderContainer");
      if (historySliderContainer) {
        historySliderContainer.classList.add("d-none");
      }
    }
    // –ü—Ä–∏ –ª—é–±–æ–º –∏–∑–º–µ–Ω–µ–Ω–∏–∏ —Å–æ—Å—Ç–æ—è–Ω–∏—è ‚Äî –æ–±–Ω–æ–≤–ª—è–µ–º –∫–Ω–æ–ø–∫–∏ –∏ –∏–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    updateUILanguage(); // –≤–Ω—É—Ç—Ä–∏ –Ω–µ—ë –≤—ã–∑—ã–≤–∞—é—Ç—Å—è updateLoginButtons(), updateUserInfo() –∏ —Ç.–¥.
  });
  // ===========================================================================


  // ======================== –†–ê–ë–û–¢–ê –° –¢–ê–ë–ê–ú–ò/–ö–û–õ–ï–°–û–ú ==========================
  function renderTabs() {
    const savedValues = {};
    spheres.forEach(sphere => {
      sphere.questions.forEach(question => {
        const slider = document.getElementById(`slider_${sphere.id}_${question.id}`);
        if (slider) {
          savedValues[sphere.id] = savedValues[sphere.id] || {};
          savedValues[sphere.id][question.id] = slider.value;
        }
      });
    });

    const tabList = document.getElementById("sphereTabs");
    const tabContent = document.getElementById("sphereTabContent");

    // –°–æ—Ö—Ä–∞–Ω—è–µ–º ID –∞–∫—Ç–∏–≤–Ω–æ–π –≤–∫–ª–∞–¥–∫–∏
    const activeTabId = document.querySelector("#sphereTabs .nav-link.active")?.id;

    tabList.innerHTML = "";
    tabContent.innerHTML = "";

    spheres.forEach((sphere) => {
      const li = document.createElement("li");
      li.className = "nav-item";

      const btn = document.createElement("button");
      btn.className = "nav-link sphere-tab-btn"; 
      btn.id = "tab-" + sphere.id;
      btn.type = "button";
      btn.setAttribute("data-color", sphere.color);
      btn.setAttribute("data-bs-toggle", "tab");
      btn.setAttribute("data-bs-target", "#pane-" + sphere.id);
      btn.role = "tab";

      let avg = (5.0).toFixed(1);
      if (savedValues[sphere.id]) {
        let sum = 0, count = 0;
        for (const key in savedValues[sphere.id]) {
          sum += parseInt(savedValues[sphere.id][key]);
          count++;
        }
        if (count) {
          avg = (sum / count).toFixed(1);
        }
      }
      let isMobileView = window.innerWidth < 576;
      if (isMobileView) {
        btn.innerHTML = `<span class="tab-emoji">${sphere.emoji || ""}</span> <span class="tab-average">${avg}</span>`;
      } else {
        btn.innerHTML = `<span class="tab-emoji">${sphere.emoji || ""}</span> <span class="tab-title">${sphere.title[currentLanguage]}</span> <span class="tab-average">(${avg})</span>`;
      }
      li.appendChild(btn);
      tabList.appendChild(li);

      const pane = document.createElement("div");
      pane.className = "tab-pane fade";
      pane.id = "pane-" + sphere.id;
      pane.role = "tabpanel";

      const header = document.createElement("h5");
      header.innerText = `${sphere.emoji || ""} ${sphere.title[currentLanguage]} - ${avg}`;
      header.className = "mb-3 mt-3";
      pane.appendChild(header);

      sphere.questions.forEach((question) => {
        const formGroup = document.createElement("div");
        formGroup.className = "mb-3";

        const label = document.createElement("label");
        label.className = "form-label sphere-header";
        label.setAttribute("for", `slider_${sphere.id}_${question.id}`);
        label.innerText = question.title[currentLanguage];
        formGroup.appendChild(label);

        const sliderWrapper = document.createElement("div");
        sliderWrapper.className = "slider-wrapper";

        const rangeContainer = document.createElement("div");
        rangeContainer.className = "range-container";

        const slider = document.createElement("input");
        slider.type = "range";
        slider.className = "form-range slider-control";
        slider.id = `slider_${sphere.id}_${question.id}`;
        slider.min = "0";
        slider.max = "10";
        slider.value = (savedValues[sphere.id] && savedValues[sphere.id][question.id]) || "5";
        slider.style.setProperty('--slider-thumb-color', sphere.color);

        slider.addEventListener("input", () => {
          updateSliderDisplay(sphere.id, question.id, slider.value);
          updateSphereAverage(sphere.id);
          drawWheel();
        });

        const desc = document.createElement("div");
        desc.id = `desc_${sphere.id}_${question.id}`;
        desc.className = "form-text slider-desc";
        const initVal = slider.value;
        desc.innerText = question.descriptions[initVal]
          ? question.descriptions[initVal][currentLanguage]
          : '';

        let val = parseInt(initVal, 10);
        let fraction = val / 10;
        let r = Math.round(255 * (1 - fraction));
        let g = Math.round(255 * fraction);
        desc.style.color = `rgb(${r}, ${g}, 0)`;

        rangeContainer.appendChild(slider);
        sliderWrapper.appendChild(rangeContainer);
        sliderWrapper.appendChild(desc);
        formGroup.appendChild(sliderWrapper);
        pane.appendChild(formGroup);
      });

      tabContent.appendChild(pane);
    });

    updateOverallAverage();

    if (activeTabId) {
      const newActiveTab = document.getElementById(activeTabId);
      if (newActiveTab) {
        newActiveTab.classList.add("active");
        const paneId = newActiveTab.getAttribute("data-bs-target");
        const activePane = document.querySelector(paneId);
        if (activePane) {
          activePane.classList.add("show", "active");
        }
      }
    } else {
      // –ï—Å–ª–∏ –∞–∫—Ç–∏–≤–Ω–æ–π –≤–∫–ª–∞–¥–∫–∏ –Ω–µ—Ç, –ø–æ–∫–∞–∑—ã–≤–∞–µ–º FAQ
      const faqTab = document.getElementById("faqBtnDesktop") || document.getElementById("faqBtnMobile");
      if (faqTab) {
        faqTab.click();
      }
    }

    const tabLinks = document.querySelectorAll("#sphereTabs .nav-link");
    tabLinks.forEach(tab => {
      tab.addEventListener("shown.bs.tab", () => {
        window.scrollTo({ top: 0, behavior: "smooth" });
        updateTabStyles();
      });
      tab.addEventListener("hidden.bs.tab", () => {
        window.scrollTo({ top: 0, behavior: "smooth" });
        updateTabStyles();
      });
      tab.addEventListener('mouseenter', () => {
        tab.style.boxShadow = `0 0 7px 2.5px ${tab.getAttribute("data-color")}`;
      });
      tab.addEventListener('mouseleave', () => {
        tab.style.boxShadow = 'none';
      });
      tab.addEventListener('click', () => {
        tab.style.boxShadow = `0 0 10px 5px ${tab.getAttribute("data-color")}`;
      });
    });
    updateTabStyles();
  }

  function updateTabStyles() {
    const tabLinks = document.querySelectorAll("#sphereTabs .nav-link");
    tabLinks.forEach(tab => {
      if (tab.classList.contains("active")) {
        tab.style.backgroundColor = tab.getAttribute("data-color");
        tab.style.color = "#333333";
      } else {
        tab.style.backgroundColor = "";
        tab.style.color = darkMode ? "#fff" : "#000";
      }
    });
  }

  function updateSliderDisplay(sphereId, questionId, value) {
    const sphere = spheres.find(s => s.id === sphereId);
    if (!sphere) return;
    const question = sphere.questions.find(q => q.id === questionId);
    if (!question) return;
    const descElem = document.getElementById(`desc_${sphereId}_${questionId}`);
    const dict = question.descriptions[value];
    descElem.innerText = dict ? dict[currentLanguage] : "";

    let val = parseInt(value, 10);
    let fraction = val / 10;
    let r = Math.round(255 * (1 - fraction));
    let g = Math.round(255 * fraction);
    descElem.style.color = `rgb(${r}, ${g}, 0)`;
  }

  function updateSphereAverage(sphereId) {
    const sphere = spheres.find(s => s.id === sphereId);
    if (!sphere) return;
    let sum = 0, count = 0;
    sphere.questions.forEach(question => {
      const slider = document.getElementById(`slider_${sphere.id}_${question.id}`);
      sum += parseInt(slider.value);
      count++;
    });

    const avg = (sum / (count || 1)).toFixed(1);
    const tabButton = document.getElementById("tab-" + sphereId);
    const isMobile = window.innerWidth < 576;

    if (isMobile) {
      tabButton.innerHTML = `<span class="tab-emoji">${sphere.emoji || ""}</span> <span class="tab-average">${avg}</span>`;
    } else {
      tabButton.innerHTML = `<span class="tab-emoji">${sphere.emoji || ""}</span> <span class="tab-title">${sphere.title[currentLanguage]}</span> <span class="tab-average">(${avg})</span>`;
    }

    const paneHeader = document.querySelector(`#pane-${sphereId} h5`);
    if (paneHeader) {
      paneHeader.innerText = `${sphere.emoji || ""} ${sphere.title[currentLanguage]} - ${avg}`;
    }
    updateOverallAverage();
  }

  function updateOverallAverage() {
    let total = 0, count = 0;
    spheres.forEach(sphere => {
      sphere.questions.forEach(question => {
        const slider = document.getElementById(`slider_${sphere.id}_${question.id}`);
        total += parseInt(slider.value);
        count++;
      });
    });
    const overall = (total / (count || 1)).toFixed(1);
    document.getElementById("overallAverage").innerText =
      (currentLanguage === "ru" ? "–û–±—â–µ–µ —Å—Ä–µ–¥–Ω–µ–µ: " : "Overall Average: ") + overall;
  }

  function drawWheel() {
    const canvas = document.getElementById("balanceWheel");
    const ctx = canvas.getContext("2d");
    const width = canvas.width;
    const height = canvas.height;
    ctx.clearRect(0, 0, width, height);

    wheelSectors = [];

    const centerX = width / 2;
    const centerY = height / 2;
    const maxRadius = Math.min(width, height) / 2 - 30;
    const anglePerSphere = (2 * Math.PI) / spheres.length;
    let startAngle = -Math.PI / 2;

    const shifts = {
      leftShift:   { x: 45,  y: 0 },
      rightShift:  { x: -60, y: 0 },
      topShift:    { x: 0,   y: -10 },
      bottomShift: { x: 0,   y: 10 }
    };
    const threshold = 0.2;

    ctx.textAlign = "center";
    ctx.textBaseline = "middle";
    ctx.font = "18px sans-serif";

    spheres.forEach((sphere) => {
      let sum = 0, count = 0;
      sphere.questions.forEach((question) => {
        const slider = document.getElementById(`slider_${sphere.id}_${question.id}`);
        sum += parseInt(slider.value);
        count++;
      });
      const avg = sum / (count || 1);
      const fraction = avg / 10;
      const sectorRadius = fraction * maxRadius;

      const endAngle = startAngle + anglePerSphere;
      ctx.beginPath();
      ctx.moveTo(centerX, centerY);
      ctx.arc(centerX, centerY, sectorRadius, startAngle, endAngle);
      ctx.closePath();
      ctx.fillStyle = sphere.color || "#CCC";
      ctx.fill();
      ctx.strokeStyle = darkMode ? "#ccc" : "#666";
      ctx.stroke();

      wheelSectors.push({
        sphereId: sphere.id,
        startAngle: startAngle,
        endAngle: endAngle,
        radius: sectorRadius,
        sphereObj: sphere
      });

      const midAngle = startAngle + anglePerSphere / 2;
      const cosMid = Math.cos(midAngle);
      const sinMid = Math.sin(midAngle);
      const labelRadius = maxRadius + 10;
      let labelX = centerX + labelRadius * cosMid;
      let labelY = centerY + labelRadius * sinMid;

      const sphereTitle = sphere.title[currentLanguage] || sphere.title["en"];
      let text = "";
      let shift = { x: 0, y: 0 };

      if (sphere.id === "selfImprovement" || sphere.id === "lifeBrightness") {
        shift.x = 10;
      }

      if (sphere.id === "health") {
        text = `${sphereTitle} ${avg.toFixed(1)} ${sphere.emoji || ""}`;
      } else {
        if (cosMid > threshold) {
          shift = shifts.rightShift;
          text = `${sphereTitle} ${avg.toFixed(1)} ${sphere.emoji || ""}`;
        } else if (cosMid < -threshold) {
          shift = shifts.leftShift;
          text = `${sphere.emoji || ""} ${sphereTitle} ${avg.toFixed(1)}`;
        } else {
          if (sinMid > 0) {
            shift = shifts.topShift;
            text = `${sphere.emoji || ""} ${sphereTitle} ${avg.toFixed(1)}`;
          } else {
            shift = shifts.bottomShift;
            text = `${sphere.emoji || ""} ${sphereTitle} ${avg.toFixed(1)}`;
          }
        }
      }
      labelX += shift.x;
      labelY += shift.y;

      ctx.shadowColor = darkMode ? "#000" : "#fff";
      ctx.shadowBlur = 2;
      ctx.fillStyle = darkMode ? "#fff" : "#000";
      ctx.fillText(text, labelX, labelY);
      ctx.shadowBlur = 0;

      ctx.beginPath();
      ctx.moveTo(centerX, centerY);
      ctx.lineTo(centerX + maxRadius * Math.cos(startAngle),
                 centerY + maxRadius * Math.sin(startAngle));
      ctx.stroke();

      startAngle = endAngle;
    });

    ctx.beginPath();
    ctx.moveTo(centerX, centerY);
    ctx.lineTo(centerX + maxRadius * Math.cos(startAngle),
               centerY + maxRadius * Math.sin(startAngle));
    ctx.stroke();
  }

  // –°–ª–∞–π–¥–µ—Ä –∏—Å—Ç–æ—Ä–∏–∏
  function initializeHistorySlider() {
    loadResultsList().then(entries => {
      if (entries.length < 2) {
        document.getElementById("historySliderContainer").classList.add("d-none");
        return;
      }
      const historySliderContainer = document.getElementById("historySliderContainer");
      historySliderContainer.classList.remove("d-none");

      entries.sort((a, b) => a.createdAt.seconds - b.createdAt.seconds);

      const historySlider = document.getElementById("historySlider");
      historySlider.min = "0";
      historySlider.max = entries.length - 1;
      historySlider.value = entries.length - 1;

      updateHistoryDateDisplay(historySlider.value, entries);
      updateCanvasFromHistory(entries, historySlider.value);

      historySlider.addEventListener("input", (e) => {
        const value = e.target.value;
        updateHistoryDateDisplay(value, entries);
        updateCanvasFromHistory(entries, value);
      });
    }).catch(error => {
      console.error("–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤:", error);
      showModal("loadErrorModal", 'loaded');
    });
  }

  function updateHistoryDateDisplay(value, entries) {
    const entry = entries[value];
    const date = new Date(entry.createdAt.seconds * 1000);
    document.getElementById("historyDateDisplay").textContent = date.toLocaleString();
  }

  function updateCanvasFromHistory(entries, index) {
    const data = entries[index].data;
    Object.keys(data).forEach(sphereId => {
      const sphereData = data[sphereId];
      Object.keys(sphereData).forEach(questionId => {
        const slider = document.getElementById(`slider_${sphereId}_${questionId}`);
        if (slider) {
          const value = sphereData[questionId];
          slider.value = value;
          updateSliderDisplay(sphereId, questionId, value);
        }
      });
      updateSphereAverage(sphereId);
    });
    drawWheel();
  }
  // ===========================================================================

  // =================== –ë–ª–æ–∫ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –≤ JSON/PDF ============================
  function initPdfFonts(doc) {
    doc.addFileToVFS("DejaVuSans.ttf", DejaVuSansTTF);
    doc.addFont("DejaVuSans.ttf", "DejaVuSans", "normal");
    doc.setFont("DejaVuSans", "normal");
  }

  // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –¥–∞—Ç—ã (–æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –≤ —É–≥–ª—É)
  function updateDateDisplay() {
    const now = new Date();
    const monthsEn = [
      "January", "February", "March", "April", "May", "June",
      "July", "August", "September", "October", "November", "December"
    ];
    const monthsRu = [
      "–Ø–Ω–≤–∞—Ä—è", "–§–µ–≤—Ä–∞–ª—è", "–ú–∞—Ä—Ç–∞", "–ê–ø—Ä–µ–ª—è", "–ú–∞—è", "–ò—é–Ω—è",
      "–ò—é–ª—è", "–ê–≤–≥—É—Å—Ç–∞", "–°–µ–Ω—Ç—è–±—Ä—è", "–û–∫—Ç—è–±—Ä—è", "–ù–æ—è–±—Ä—è", "–î–µ–∫–∞–±—Ä—è"
    ];
    const day = now.getDate();
    const monthIndex = now.getMonth();
    const year = now.getFullYear();

    if (currentLanguage === "ru") {
      const monthName = monthsRu[monthIndex];
      const dateString = `${day} ${monthName} ${year}`;
      document.getElementById("currentDate").innerText = `(${dateString})`;
    } else {
      const monthName = monthsEn[monthIndex];
      const dateString = `${monthName} ${day}, ${year}`;
      document.getElementById("currentDate").innerText = `(${dateString})`;
    }
  }

  document.getElementById("saveResults")?.addEventListener("click", () => {
    let results = {};
    results.date = new Date().toISOString();
    spheres.forEach((sphere) => {
      let sphereData = {};
      sphere.questions.forEach((question) => {
        const slider = document.getElementById(`slider_${sphere.id}_${question.id}`);
        sphereData[question.id] = parseInt(slider.value);
      });
      results[sphere.id] = sphereData;
    });
    const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(results, null, 2));
    const downloadAnchor = document.createElement("a");
    downloadAnchor.setAttribute("href", dataStr);
    downloadAnchor.setAttribute("download", "results.json");
    document.body.appendChild(downloadAnchor);
    downloadAnchor.click();
    downloadAnchor.remove();
  });

  document.getElementById("savePDF")?.addEventListener("click", async () => {
    await document.fonts.ready;
    const originalDarkMode = darkMode;
    darkMode = false;
    document.body.classList.remove("dark-mode");

    const canvas = document.getElementById("balanceWheel");
    canvas.width = 800;
    canvas.height = 800;

    drawWheel();

    const ctx = canvas.getContext("2d");
    ctx.imageSmoothingEnabled = true;
    ctx.imageSmoothingQuality = "high";

    fillCanvasBackground(canvas, "#ffffff");

    setTimeout(() => {
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF({ unit: "px", format: "a4" });
      initPdfFonts(doc);

      const now = new Date();
      const day = now.getDate();
      const month = now.getMonth() + 1;
      const year = now.getFullYear();
      const dateString = `${day}.${month}.${year}`;

      const canvasData = canvas.toDataURL("image/png");

      let yPos = 20;
      const margin = 20;
      const pageHeight = doc.internal.pageSize.height;
      const pageWidth = doc.internal.pageSize.getWidth();
      const maxTextWidth = pageWidth - margin * 2;

      doc.setFontSize(12);
      doc.text(`Mentorist Balance Wheel (${dateString})`, margin, yPos);
      yPos += 20;

      const imageWidth = 200;
      const xPos = (pageWidth - imageWidth) / 2;
      doc.addImage(canvasData, "PNG", xPos, yPos, imageWidth, 200);
      yPos += 220;
      doc.setFontSize(10);

      spheres.forEach((sphere) => {
        let sum = 0, count = 0;
        sphere.questions.forEach((question) => {
          const slider = document.getElementById(`slider_${sphere.id}_${question.id}`);
          sum += parseInt(slider.value);
          count++;
        });
        const avg = (sum / (count || 1)).toFixed(1);
        const sphereLine = `${sphere.title[currentLanguage]} ${avg}`;
        let sphereLines = doc.splitTextToSize(sphereLine, maxTextWidth);

        sphereLines.forEach((line) => {
          if (yPos > pageHeight - margin) {
            doc.addPage();
            yPos = margin;
          }
          doc.text(line, margin, yPos);
          yPos += 15;
        });

        sphere.questions.forEach((question) => {
          const slider = document.getElementById(`slider_${sphere.id}_${question.id}`);
          const value = slider.value;
          const answer = question.descriptions[value] ? question.descriptions[value][currentLanguage] : "";
          const questionLine = `${question.title[currentLanguage]}: ${answer}`;

          let questionLines = doc.splitTextToSize(questionLine, maxTextWidth);
          questionLines.forEach((line) => {
            if (yPos > pageHeight - margin) {
              doc.addPage();
              yPos = margin;
            }
            doc.text(line, margin + 10, yPos);
            yPos += 15;
          });
        });
        yPos += 10;
      });

      let total = 0, globalCount = 0;
      spheres.forEach((sphere) => {
        sphere.questions.forEach((question) => {
          const slider = document.getElementById(`slider_${sphere.id}_${question.id}`);
          total += parseInt(slider.value);
          globalCount++;
        });
      });
      const overall = (total / (globalCount || 1)).toFixed(1);
      const overallText = (currentLanguage === "ru" ? "–û–±—â–µ–µ —Å—Ä–µ–¥–Ω–µ–µ: " : "Overall Average: ") + overall;

      let overallLines = doc.splitTextToSize(overallText, maxTextWidth);
      overallLines.forEach((line) => {
        if (yPos > pageHeight - margin) {
          doc.addPage();
          yPos = margin;
        }
        doc.text(line, margin, yPos);
        yPos += 15;
      });

      doc.save("results.pdf");
    }, 200);

    setTimeout(() => {
      darkMode = originalDarkMode;
      if (darkMode) {
        document.body.classList.add("dark-mode");
      } else {
        document.body.classList.remove("dark-mode");
      }
      drawWheel();
    }, 600);
  });
  // ====================== –ö–æ–Ω–µ—Ü —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è JSON/PDF ==========================

  // –ò–∑–Ω–∞—á–∞–ª—å–Ω–∞—è –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
  function setupButtons() {
    const faqContent = document.getElementById("faqContent");
    const sphereTabContent = document.getElementById("sphereTabContent");

    if (faqContent) {
      faqContent.style.display = "block";
      faqContent.innerHTML = faqInstructions[currentLanguage];
    }
    if (sphereTabContent) {
      sphereTabContent.style.display = "block";
    }

    const themeBtn = document.getElementById("themeToggle");
    const langBtn = document.getElementById("langToggle");

    themeBtn.addEventListener("click", () => {
      darkMode = !darkMode;
      document.body.classList.toggle("dark-mode", darkMode);
      themeBtn.innerText = darkMode
        ? (currentLanguage === "ru" ? "üåô –¢—ë–º–Ω–∞—è" : "üåô Dark")
        : (currentLanguage === "ru" ? "üåû –°–≤–µ—Ç–ª–∞—è" : "üåû Light");
      updateUILanguage();
      updateTabStyles();
      drawWheel();
    });

    // FAQ-–∫–Ω–æ–ø–∫–∏
    const faqBtnDesktop = document.getElementById("faqBtnDesktop");
    const faqBtnMobile = document.getElementById("faqBtnMobile");

    function handleFaqClick() {
      if (!faqContent || !sphereTabContent) return;
      faqContent.innerHTML = faqInstructions[currentLanguage];
      sphereTabContent.style.display = "none";
      faqContent.style.display = "block";

      const tabLinks = document.querySelectorAll("#sphereTabs .nav-link");
      tabLinks.forEach(tab => {
        tab.classList.remove("active");
        tab.style.boxShadow = 'none';
        const targetPane = document.querySelector(tab.getAttribute("data-bs-target"));
        if (targetPane) {
          targetPane.classList.remove("show", "active");
        }
      });
      if (window.innerWidth <= 576) {
        window.scrollTo({ top: 0, behavior: "smooth" });
      }
    }
    if (faqBtnDesktop) faqBtnDesktop.addEventListener("click", handleFaqClick);
    if (faqBtnMobile) faqBtnMobile.addEventListener("click", handleFaqClick);

    langBtn.addEventListener("click", () => {
      const faqContent = document.getElementById("faqContent");
      const faqIsOpen = faqContent.style.display !== "none";

      const savedValues = {};
      spheres.forEach(sphere => {
        sphere.questions.forEach(question => {
          const slider = document.getElementById(`slider_${sphere.id}_${question.id}`);
          if (slider) {
            savedValues[sphere.id] = savedValues[sphere.id] || {};
            savedValues[sphere.id][question.id] = slider.value;
          }
        });
      });

      // –ü–µ—Ä–µ–∫–ª—é—á–∞–µ–º —è–∑—ã–∫
      currentLanguage = (currentLanguage === "ru") ? "en" : "ru";

      langBtn.innerText = (currentLanguage === "ru") ? "üåê RU" : "üåê EN";
      themeBtn.innerText = darkMode
        ? (currentLanguage === "ru" ? "üåô –¢—ë–º–Ω–∞—è" : "üåô Dark")
        : (currentLanguage === "ru" ? "üåû –°–≤–µ—Ç–ª–∞—è" : "üåû Light");
      const savePdfBtn = document.getElementById("savePDF");
      if (savePdfBtn) {
        savePdfBtn.innerText = (currentLanguage === "ru") ? "üîΩ PDF" : "üîΩ PDF";
      }

      updateDateDisplay();
      updateUILanguage();

      renderTabs();
      spheres.forEach(sphere => {
        if (savedValues[sphere.id]) {
          sphere.questions.forEach(question => {
            const slider = document.getElementById(`slider_${sphere.id}_${question.id}`);
            if (slider && savedValues[sphere.id][question.id]) {
              slider.value = savedValues[sphere.id][question.id];
              updateSliderDisplay(sphere.id, question.id, slider.value);
            }
          });
          updateSphereAverage(sphere.id);
        }
      });
      updateTabStyles();
      drawWheel();

      if (faqIsOpen) {
        faqContent.innerHTML = faqInstructions[currentLanguage];
      }
      const sphereTabs = document.querySelectorAll("#sphereTabs .nav-link");
      sphereTabs.forEach(tab => {
        tab.addEventListener("click", () => {
          faqContent.style.display = "none";
          document.getElementById("sphereTabContent").style.display = "block";
        });
      });
    });
  }

  // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
  renderTabs();
  updateDateDisplay();
  drawWheel();
  setupButtons();

  // –ï—Å–ª–∏ –Ω–∞ –º–æ–±–∏–ª—å–Ω–æ–º –ª–∏—Å—Ç–∞–µ–º –≤–Ω–∏–∑ ‚Äî —Å–∫—Ä—ã–≤–∞–µ–º –≤–∫–ª–∞–¥–∫–∏, –≤–≤–µ—Ä—Ö ‚Äî –ø–æ–∫–∞–∑—ã–≤–∞–µ–º
  let lastScrollTop = 0;
  window.addEventListener("scroll", function() {
    if (window.innerWidth >= 576) return;
    let st = window.pageYOffset || document.documentElement.scrollTop;
    if (st > lastScrollTop) {
      document.getElementById("sphereTabs").style.transform = "translateY(-200%)";
    } else {
      document.getElementById("sphereTabs").style.transform = "translateY(0)";
    }
    lastScrollTop = st <= 0 ? 0 : st;
  }, false);

  // 3D-—ç—Ñ—Ñ–µ–∫—Ç –ø—Ä–∏ –Ω–∞–≤–µ–¥–µ–Ω–∏–∏ –Ω–∞ –∫–æ–ª–µ—Å–æ
  const canvasWrapper = document.getElementById('canvas-wrapper');
  const wheelContainer = document.getElementById('balanceWheelContainer');
  const glow = wheelContainer.querySelector('.glow');
  let bounds;

  function showSphereTooltip(e) {
    const canvas = document.getElementById("balanceWheel");
    const tooltip = document.getElementById("canvasTooltip");
    const rect = canvas.getBoundingClientRect();
    const xInCanvas = e.clientX - rect.left;
    const yInCanvas = e.clientY - rect.top;

    const hoveredSector = getSectorUnderCursor(xInCanvas, yInCanvas);
    if (!hoveredSector) {
      tooltip.style.display = 'none';
      return;
    }
    const sphere = hoveredSector.sphereObj;
    const sphereTitle = sphere.title[currentLanguage] || sphere.title["en"];
    let questionsHtml = '';
    sphere.questions.forEach(question => {
      const sliderId = `slider_${sphere.id}_${question.id}`;
      const sliderEl = document.getElementById(sliderId);
      if (!sliderEl) return;
      const val = sliderEl.value;
      const desc = question.descriptions[val] 
        ? question.descriptions[val][currentLanguage] 
        : '';
      questionsHtml += `<div style="margin-bottom:2px;">
        <strong>${question.title[currentLanguage]}:</strong> ${desc}
      </div>`;
    });
    const tooltipHtml = `
      <div style="font-weight:600; margin-bottom:6px;">${sphereTitle}</div>
      ${questionsHtml}
    `;
    tooltip.innerHTML = tooltipHtml;
    tooltip.style.left = (e.pageX + 15) + 'px';
    tooltip.style.top  = (e.pageY + 15) + 'px';
    tooltip.style.display = 'block';
  }

  function isAngleInArc(angle, start, end) {
    if (start <= end) {
      return angle >= start && angle <= end;
    } else {
      return (angle >= start && angle < 2 * Math.PI) || (angle >= 0 && angle <= end);
    }
  }

  function getSectorUnderCursor(mouseX, mouseY) {
    const canvas = document.getElementById("balanceWheel");
    const centerX = canvas.width / 2;
    const centerY = canvas.height / 2;
    const dx = mouseX - centerX;
    const dy = mouseY - centerY;
    const r = Math.sqrt(dx * dx + dy * dy);
    let angle = Math.atan2(dy, dx);
    if (angle < 0) {
      angle += 2 * Math.PI;
    }
    for (let sector of wheelSectors) {
      let startAngle = sector.startAngle;
      let endAngle = sector.endAngle;
      if (startAngle < 0) startAngle += 2 * Math.PI;
      if (endAngle < 0) endAngle += 2 * Math.PI;
      if (isAngleInArc(angle, startAngle, endAngle)) {
        if (r <= sector.radius) {
          return sector;
        }
      }
    }
    return null;
  }

  function rotateCanvas(e) {
    const mouseX = e.clientX;
    const mouseY = e.clientY;
    const leftX = mouseX - bounds.x;
    const topY = mouseY - bounds.y;
    const center = {
      x: leftX - bounds.width / 2,
      y: topY - bounds.height / 2
    };
    const distance = Math.sqrt(center.x ** 2 + center.y ** 2);

    wheelContainer.style.transform = `
      scale3d(1.07, 1.07, 1.07)
      rotate3d(
        ${center.y / 100},
        ${-center.x / 100},
        0,
        ${Math.log(distance) * 2}deg
      )
    `;
    glow.style.backgroundImage = `
      radial-gradient(
        circle at
        ${leftX}px ${topY}px,
        rgba(255, 255, 255, 0.2),
        transparent 70%
      )
    `;
    showSphereTooltip(e);
  }

  canvasWrapper.addEventListener('mouseenter', () => {
    bounds = wheelContainer.getBoundingClientRect();
    document.addEventListener('mousemove', rotateCanvas);
  });

  canvasWrapper.addEventListener('mouseleave', () => {
    document.removeEventListener('mousemove', rotateCanvas);
    wheelContainer.style.transform = 'scale3d(1, 1, 1) rotate3d(0, 0, 0, 0deg)';
    glow.style.backgroundImage = 'none';
    const tooltip = document.getElementById('canvasTooltip');
    if (tooltip) {
      tooltip.style.display = 'none';
    }
  });
});
// –ö–æ–Ω–µ—Ü DOMContentLoaded
